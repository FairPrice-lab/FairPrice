<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FairPrice — Quote Check</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Upload a quote and instantly see if it’s likely under/fair/over market. Pay to unlock a full local/state/national comparison." />

  <style>
    :root{
      --bg:#07121f;
      --panel:rgba(255,255,255,.03);
      --text:#eaf2ff;
      --muted:#a6b6d6;
      --line:rgba(255,255,255,.10);
      --trust:#6ee7ff;
      --save:#86efac;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1000px 520px at 18% -8%, rgba(110,231,255,.14), transparent 60%),
        radial-gradient(900px 520px at 82% -10%, rgba(134,239,172,.10), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .container{max-width:860px;margin:0 auto;padding:34px 18px 60px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      padding:10px 12px;border:1px solid var(--line);border-radius:999px;
      background:var(--panel);box-shadow:var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:950}
    .logo{width:30px;height:30px;border-radius:12px;background:linear-gradient(135deg,var(--trust),var(--save))}
    .pill{font-size:12px;color:var(--muted);border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:rgba(255,255,255,.02)}
    h1{margin:18px 0 8px;font-size:40px;line-height:1.08}
    .sub{margin:0;color:var(--muted);line-height:1.6;max-width:720px}
    .card{
      margin-top:18px;border:1px solid var(--line);border-radius:var(--r);
      background:var(--panel);box-shadow:var(--shadow);overflow:hidden;
    }
    .cardHead{padding:14px 16px;border-bottom:1px solid var(--line);background:rgba(255,255,255,.02)}
    .cardHead b{font-size:14px}
    .cardBody{padding:16px}
    label{display:block;font-size:13px;font-weight:850;margin:12px 0 7px}
    input,select,textarea,button{
      width:100%;padding:11px 12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(7,18,31,.55);color:var(--text);outline:none;
    }
    textarea{resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.row{grid-template-columns:1fr}}
    .btn{
      margin-top:12px;border:none;border-radius:14px;padding:12px 14px;font-weight:950;cursor:pointer;
      color:#06121f;background:linear-gradient(135deg,var(--trust),var(--save));
    }
    .status{margin-top:10px;color:var(--muted);font-size:13px;line-height:1.5}
    .result{
      display:none;margin-top:14px;border:1px solid var(--line);border-radius:var(--r);
      background:rgba(255,255,255,.02);padding:14px;
    }
    .resultTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
    .tag{font-size:12px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted)}
    .bar{margin-top:10px;border:1px solid var(--line);border-radius:999px;height:14px;overflow:hidden;background:rgba(255,255,255,.04)}
    .barFill{height:100%;width:0%;background:linear-gradient(90deg, rgba(134,239,172,.75), rgba(110,231,255,.75))}
    .legend{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;margin-top:6px}
    .copy{margin-top:10px;line-height:1.55}
    .divider{height:1px;background:var(--line);margin:14px 0}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.grid2{grid-template-columns:1fr}}
    .mini{border:1px solid var(--line);border-radius:14px;padding:10px;background:rgba(255,255,255,.02)}
    .mini b{display:block;margin-bottom:4px}
    .paybox{
      border:1px solid var(--line);border-radius:14px;padding:12px;background:rgba(255,255,255,.02);
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
    }
    .payBtns{display:flex;gap:10px;flex-wrap:wrap}
    .btn2{
      border:none;border-radius:14px;padding:10px 12px;font-weight:950;cursor:pointer;
      color:#06121f;background:linear-gradient(135deg,var(--trust),var(--save));
    }
    .btn2.secondary{
      color:var(--text);background:rgba(255,255,255,.03);border:1px solid var(--line);
    }
    .fine{
      margin-top:12px;color:var(--muted);font-size:11px;line-height:1.5;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="top">
      <div class="brand"><div class="logo"></div>FairPrice</div>
      <div class="pill">Free fairness preview</div>
    </div>

    <h1>Check a quote in 30 seconds.</h1>
    <p class="sub">
      Upload a quote (PDF/image) or paste text. Get a free fairness signal (under / fair / over).
      Unlock the full report only if you want the numbers.
    </p>

    <div class="card">
      <div class="cardHead">
        <b>Upload → Preview → Unlock (optional)</b>
      </div>

      <div class="cardBody">
        <label>Upload quote (PDF / image)</label>
        <input id="file" type="file" accept=".pdf,image/*" />

        <label>Or paste quote text (optional)</label>
        <textarea id="quoteText" rows="4" placeholder="Paste quote text here…"></textarea>

        <div class="row">
          <div>
            <label>Quote type</label>
            <select id="category">
              <option>Home services (repairs/visit)</option>
              <option>Home projects (install/remodel)</option>
              <option>Auto (repair/body)</option>
              <option>Medical (out-of-pocket)</option>
              <option>Moving / logistics</option>
              <option>Professional services</option>
              <option>Bills / recurring charges</option>
              <option>Other</option>
            </select>
          </div>

          <div>
            <label>Scale</label>
            <select id="scale">
              <option value="small">Small</option>
              <option value="medium" selected>Medium</option>
              <option value="large">Large</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>ZIP</label>
            <input id="zip" inputmode="numeric" placeholder="e.g., 92618" />
          </div>
          <div>
            <label>Total price</label>
            <input id="price" inputmode="decimal" placeholder="e.g., 514.19" />
          </div>
        </div>

        <button class="btn" id="previewBtn">Check fairness (free)</button>

        <div id="status" class="status"></div>

        <div id="result" class="result">
          <div class="resultTop">
            <b id="resultTitle">Free fairness preview</b>
            <span class="tag" id="resultTag">—</span>
          </div>

          <div class="bar"><div id="barFill" class="barFill"></div></div>
          <div class="legend"><span>Under</span><span>Fair</span><span>Over</span></div>

          <div id="resultText" class="copy"></div>

          <div id="fullExtras" style="display:none">
            <div class="divider"></div>
            <div class="grid2">
              <div class="mini">
                <b>Local / State / National</b>
                <div id="marketComp">—</div>
              </div>
              <div class="mini">
                <b>Estimated margin band</b>
                <div id="marginEst">—</div>
              </div>
            </div>
            <div class="grid2" style="margin-top:10px">
              <div class="mini">
                <b>Estimated fair range</b>
                <div id="rangeOut">—</div>
              </div>
              <div class="mini">
                <b>What to do next</b>
                <div id="tipsOut">—</div>
              </div>
            </div>
            <div class="fine" id="dataNote"></div>
          </div>

          <div class="divider"></div>

          <div class="paybox">
            <div>
              <b>Unlock full report</b>
              <div class="fine" style="margin-top:4px">One-time <b>$6.99</b> • Unlimited <b>$17.99/mo</b></div>
            </div>
            <div class="payBtns">
              <button class="btn2" id="payOnceBtn">Pay $6.99</button>
              <button class="btn2 secondary" id="subscribeBtn">Subscribe</button>
            </div>
          </div>
        </div>

        <!-- Small underwriting disclaimer only -->
        <div class="fine">
          Disclaimer: FairPrice provides informational estimates only and is not legal, financial, medical/health, tax, or insurance advice.
          Results may be inaccurate and are not guarantees. Use at your own risk.
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);
  function setStatus(msg){ $("status").textContent = msg || ""; }
  function clamp01(x){ return Math.max(0, Math.min(1, x)); }
  function setScale(score01){ $("barFill").style.width = (clamp01(score01) * 100) + "%"; }

  async function toBase64(file){
    return new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result.split(",")[1]);
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }

  function getSessionIdFromUrl(){
    const p = new URLSearchParams(window.location.search);
    return p.get("session_id");
  }

  async function buildPayload(){
    const f = $("file").files[0];
    if (f && f.size > 6 * 1024 * 1024) throw new Error("File too large. Please upload ~5MB or less.");
    return {
      category: $("category").value,
      scale: $("scale").value,
      zip: $("zip").value.trim(),
      price: $("price").value.trim(),
      quoteText: $("quoteText").value.trim(),
      fileName: f ? f.name : null,
      fileType: f ? f.type : null,
      fileBase64: f ? await toBase64(f) : null
    };
  }

  async function postJSON(url, body){
    const res = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    if (!res.ok) {
      const t = await res.text();
      throw new Error(`API ${res.status}: ${t}`);
    }
    return res.json();
  }

  function showPreview(data){
    $("result").style.display = "block";
    $("fullExtras").style.display = "none";
    $("resultTitle").textContent = "Free fairness preview";
    $("resultTag").textContent = (data?.label || "RESULT").toUpperCase();
    setScale(data?.score ?? 0.5);
    $("resultText").textContent = data?.message || "Preview generated.";
  }

  function showFull(data){
    $("result").style.display = "block";
    $("fullExtras").style.display = "block";
    $("resultTitle").textContent = "Full report";
    $("resultTag").textContent = (data?.label || "FULL").toUpperCase();
    setScale(data?.score ?? 0.5);
    $("resultText").textContent = "✅ Payment verified. Full report unlocked.";

    $("marketComp").textContent = data?.full_report?.market_comparison || "—";
    $("marginEst").textContent  = data?.full_report?.estimated_margin || "—";
    $("rangeOut").textContent   = data?.full_report?.price_range || "—";
    $("tipsOut").textContent    = data?.full_report?.tips || "—";
    $("dataNote").textContent   = data?.full_report?.data_note || "";
  }

  $("previewBtn").onclick = async () => {
    $("previewBtn").disabled = true;
    setStatus("Checking fairness…");
    $("result").style.display = "none";
    try{
      const payload = await buildPayload();
      const data = await postJSON("/api/analyze", { ...payload, mode:"preview" });
      setStatus("");
      showPreview(data);
    } catch(e){
      setStatus("Error: " + (e?.message || "unknown"));
    } finally {
      $("previewBtn").disabled = false;
    }
  };

  async function startCheckout(kind){
    setStatus("Opening secure checkout…");
    try{
      const data = await postJSON("/api/create-checkout-session", { kind });
      if (data?.url) window.location.href = data.url;
      else setStatus("Checkout error (no URL).");
    } catch(e){
      setStatus("Checkout error: " + (e?.message || "unknown"));
    }
  }
  $("payOnceBtn").onclick = () => startCheckout("once");
  $("subscribeBtn").onclick = () => startCheckout("sub");

  // Auto-unlock after Stripe redirect
  (async () => {
    const sessionId = getSessionIdFromUrl();
    if (!sessionId) return;

    setStatus("Payment detected. Verifying…");
    try{
      const payload = await buildPayload();
      const data = await postJSON("/api/analyze", { ...payload, mode:"full", session_id: sessionId });
      setStatus("");
      showFull(data);
    } catch(e){
      setStatus("Unlock error: " + (e?.message || "unknown"));
    }
  })();
</script>
</body>
</html>
