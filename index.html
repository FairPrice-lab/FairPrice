<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FairPrice ‚Äî Consumer Pricing Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Upload a quote and instantly see if it‚Äôs likely under/fair/over market. Pay to unlock a full local/state/national comparison." />
  <style>
    :root{
      --bg:#07121f;
      --panel:#0c1a2d;
      --panel2:#0a1728;
      --text:#eaf2ff;
      --muted:#a6b6d6;
      --line:rgba(255,255,255,.10);
      --trust:#6ee7ff;   /* trust blue */
      --save:#86efac;    /* savings green */
      --warn:#fde68a;
      --danger:#fecaca;
      --shadow: 0 20px 50px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(110,231,255,.18), transparent 55%),
                  radial-gradient(1000px 600px at 80% -10%, rgba(134,239,172,.12), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .container{max-width:1100px;margin:0 auto;padding:34px 18px 60px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      padding:12px 14px;border:1px solid var(--line);border-radius:999px;
      background: rgba(255,255,255,.03); box-shadow: var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:950}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(135deg, var(--trust), var(--save));
      box-shadow: 0 10px 30px rgba(110,231,255,.18);
    }
    .brand span{letter-spacing:.2px}
    .badgeRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line); border-radius:999px; padding:6px 10px;
      background: rgba(255,255,255,.02);
    }
    .hero{
      margin-top:22px;
      display:grid;grid-template-columns:1.15fr .85fr;gap:16px;
      align-items:stretch;
    }
    @media (max-width: 900px){ .hero{grid-template-columns:1fr} }
    .heroLeft{
      padding:22px;border-radius:var(--radius);
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      position:relative; overflow:hidden;
    }
    .heroLeft:before{
      content:""; position:absolute; inset:-80px -120px auto auto; width:280px; height:280px;
      background: radial-gradient(circle at 30% 30%, rgba(110,231,255,.25), transparent 60%);
      filter: blur(0px); pointer-events:none;
    }
    h1{margin:0 0 10px;font-size:44px;line-height:1.06}
    .sub{margin:0;color:var(--muted);line-height:1.6;max-width:680px}
    .trustRow{
      margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;color:var(--muted);
      font-size:13px;
    }
    .trustItem{
      display:flex;gap:8px;align-items:center;
      border:1px solid var(--line);border-radius:999px;padding:7px 10px;
      background: rgba(255,255,255,.02);
    }
    .dot{width:8px;height:8px;border-radius:999px;background: var(--save)}
    .dot.blue{background: var(--trust)}
    .dot.gray{background: rgba(255,255,255,.28)}
    .heroRight{
      padding:18px;border-radius:var(--radius);
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
    }
    .stepsTitle{font-weight:900;margin:2px 0 10px}
    .step{
      border:1px solid var(--line);border-radius:var(--radius2);
      padding:10px 12px;background: rgba(255,255,255,.02);
      margin-bottom:10px;
    }
    .step b{display:block;margin-bottom:4px}
    .step small{color:var(--muted);line-height:1.5}
    .grid{
      margin-top:18px;
      display:grid;grid-template-columns:1fr; gap:14px;
    }
    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:14px 16px;
      background: linear-gradient(135deg, rgba(110,231,255,.10), rgba(134,239,172,.07));
      border-bottom:1px solid var(--line);
    }
    .cardHeader b{font-size:15px}
    .cardHeader .miniSub{margin-top:4px;color:var(--muted);font-size:12px;line-height:1.4}
    .cardBody{padding:16px}
    label{display:block;font-size:13px;font-weight:850;margin:12px 0 7px}
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(7,18,31,.55);
      color: var(--text);
      outline:none;
    }
    textarea{resize:vertical}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    @media (max-width: 820px){ .row3{grid-template-columns:1fr} }
    .actions{
      margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center
    }
    .btn{
      flex:1 1 240px;
      border:none;
      border-radius:14px;
      padding:12px 14px;
      font-weight:950;
      cursor:pointer;
      color:#06121f;
      background: linear-gradient(135deg, var(--trust), var(--save));
      transition: transform .12s ease, opacity .12s ease;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn:hover{transform: translateY(-1px)}
    .btn.secondary{
      background: rgba(255,255,255,.04);
      color: var(--text);
      border:1px solid var(--line);
    }
    .status{margin-top:10px;color:var(--muted);font-size:13px;line-height:1.5}
    .result{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:var(--radius);
      background: rgba(255,255,255,.03);
      padding:14px;
      display:none;
    }
    .resultTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
    .tag{
      font-size:12px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      color: var(--muted);
      background: rgba(255,255,255,.02);
    }
    .bar{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:999px;
      height:14px;
      overflow:hidden;
      background: rgba(255,255,255,.04);
    }
    .barFill{height:100%;width:0%}
    .barLegend{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;margin-top:6px}
    .copy{margin-top:10px;line-height:1.55}
    .divider{height:1px;background: var(--line); margin:14px 0}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 820px){ .grid2{grid-template-columns:1fr} }
    .mini{
      border:1px solid var(--line);border-radius:14px;padding:10px;
      background: rgba(255,255,255,.02)
    }
    .mini b{display:block;margin-bottom:4px}
    .fine{
      margin-top:10px;color:var(--muted);font-size:12px;line-height:1.5
    }
    .drop{
      border:1px dashed rgba(255,255,255,.18);
      border-radius:14px;
      padding:12px;
      background: rgba(255,255,255,.02);
    }
    .dropRow{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .dropHint{color:var(--muted);font-size:12px;line-height:1.4}
    .filePill{
      border:1px solid var(--line);border-radius:999px;padding:6px 10px;
      font-size:12px;color:var(--muted);background: rgba(255,255,255,.02);
      max-width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .socialProof{
      margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;color:var(--muted);font-size:12px
    }
    .quoteBox{
      border:1px solid var(--line);border-radius:14px;padding:10px;background: rgba(255,255,255,.02)
    }
    .footer{
      margin-top:16px;
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      background: rgba(255,255,255,.02);
      color: var(--muted);
      font-size:12px;
      line-height:1.55;
    }
  </style>
</head>
<body>
  <div class="container">

    <div class="topbar">
      <div class="brand"><div class="logo"></div><span>FairPrice</span></div>
      <div class="badgeRow">
        <div class="pill">Consumer Pricing Guide</div>
        <div class="pill">Free fairness preview</div>
        <div class="pill">Secure checkout</div>
      </div>
    </div>

    <div class="hero">
      <div class="heroLeft">
        <h1>Know if a quote is fair ‚Äî<br/>before you commit.</h1>
        <p class="sub">
          Upload a quote (PDF/image) or paste text. Get a free ‚Äúunder / fair / over‚Äù signal without revealing detailed benchmarks.
          Unlock the full local/state/national comparison when you‚Äôre ready.
        </p>

        <div class="trustRow">
          <div class="trustItem"><span class="dot blue"></span><span>Uses public BLS inflation data</span></div>
          <div class="trustItem"><span class="dot"></span><span>Designed to help you avoid overpaying</span></div>
          <div class="trustItem"><span class="dot gray"></span><span>No professional advice claims</span></div>
        </div>

        <div class="socialProof">
          <span class="pill">‚ö° Fast preview</span>
          <span class="pill">üîí Paywall for detailed metrics</span>
          <span class="pill">‚úÖ Clear next steps</span>
        </div>
      </div>

      <div class="heroRight">
        <div class="stepsTitle">How it works</div>
        <div class="step">
          <b>1) Upload or paste</b>
          <small>Use a PDF/image or paste the quote text. Add total price + ZIP for best accuracy.</small>
        </div>
        <div class="step">
          <b>2) Free fairness preview</b>
          <small>You‚Äôll see under/fair/over + a scale bar. We keep benchmark numbers hidden in preview.</small>
        </div>
        <div class="step" style="margin-bottom:0">
          <b>3) Unlock full report</b>
          <small>$6.99 one-time or $17.99/mo unlimited ‚Äî includes local/state/national comparison + margin band + tips.</small>
        </div>
      </div>
    </div>

    <div class="grid">

      <div class="card">
        <div class="cardHeader">
          <b>Upload & Analyze</b>
          <div class="miniSub">Best results: add the total price, ZIP, and choose the closest category + scale.</div>
        </div>
        <div class="cardBody">

          <label>Quote file (PDF / image)</label>
          <div id="drop" class="drop">
            <div class="dropRow">
              <div>
                <div class="dropHint"><b>Drag & drop</b> a file here, or choose a file.</div>
                <div class="dropHint">Accepted: PDF, JPG, PNG. (Max ~5MB recommended)</div>
              </div>
              <div>
                <input id="file" type="file" accept=".pdf,image/*" />
              </div>
            </div>
            <div style="margin-top:10px">
              <div id="fileLabel" class="filePill">No file selected</div>
            </div>
          </div>

          <label>Or paste quote text (optional)</label>
          <textarea id="quoteText" rows="4" placeholder="Paste the quote here‚Ä¶ (scope, line items, total, etc.)"></textarea>

          <div class="row3">
            <div>
              <label>Quote type</label>
              <select id="category">
                <option>Home services (repairs/visit)</option>
                <option>Home projects (install/remodel)</option>
                <option>Auto (repair/body)</option>
                <option>Medical (out-of-pocket)</option>
                <option>Moving / logistics</option>
                <option>Professional services</option>
                <option>Bills / recurring charges</option>
                <option>Other</option>
              </select>
            </div>
            <div>
              <label>Scale</label>
              <select id="scale">
                <option value="small">Small</option>
                <option value="medium" selected>Medium</option>
                <option value="large">Large</option>
              </select>
            </div>
            <div>
              <label>ZIP (for local baseline)</label>
              <input id="zip" inputmode="numeric" placeholder="e.g., 92618" />
            </div>
          </div>

          <label>Total price (recommended)</label>
          <input id="price" inputmode="decimal" placeholder="e.g., 514.19" />

          <div class="actions">
            <button class="btn" id="previewBtn">Check fairness (free)</button>
            <button class="btn secondary" id="resetBtn" type="button">Reset</button>
          </div>

          <div id="status" class="status"></div>

          <div id="result" class="result">
            <div class="resultTop">
              <b id="resultTitle">Free fairness preview</b>
              <span class="tag" id="resultTag">‚Äî</span>
            </div>

            <div class="bar"><div id="barFill" class="barFill"></div></div>
            <div class="barLegend"><span>Under</span><span>Fair</span><span>Over</span></div>

            <div id="resultText" class="copy"></div>

            <div id="fullExtras" style="display:none">
              <div class="divider"></div>

              <div class="grid2">
                <div class="mini">
                  <b>Local / State / National</b>
                  <div id="marketComp">‚Äî</div>
                </div>
                <div class="mini">
                  <b>Estimated margin band</b>
                  <div id="marginEst">‚Äî</div>
                </div>
              </div>

              <div class="grid2" style="margin-top:10px">
                <div class="mini">
                  <b>Estimated fair range</b>
                  <div id="rangeOut">‚Äî</div>
                </div>
                <div class="mini">
                  <b>What to do next</b>
                  <div id="tipsOut">‚Äî</div>
                </div>
              </div>

              <div class="fine" id="dataNote"></div>
            </div>

            <div class="divider"></div>

            <div class="quoteBox">
              <b>Unlock full report</b>
              <div class="fine">One-time: <b>$6.99</b> ‚Ä¢ Unlimited: <b>$17.99/mo</b></div>
              <div class="actions" style="margin-top:10px">
                <button class="btn" id="payOnceBtn">Pay $6.99</button>
                <button class="btn secondary" id="subscribeBtn">Subscribe</button>
              </div>

              <div class="fine" style="margin-top:10px">
                Backup links:
                <a id="payOnceLink" target="_blank" rel="noopener">Pay $6.99</a>
                ‚Ä¢
                <a id="subLink" target="_blank" rel="noopener">Subscribe</a>
              </div>
            </div>
          </div>

          <div class="footer">
            <b>Disclaimer (read):</b> FairPrice is an informational <b>Consumer Pricing Guide</b> (‚Äúsocial advisor‚Äù) only.
            It does <b>not</b> provide financial, legal, tax, medical/health, insurance, contracting, or other professional advice.
            Estimates are generalized, may be incomplete/incorrect, and may not reflect real-world scope, quality, permits, labor, or materials.
            We do not guarantee savings, outcomes, or accuracy. Always consult qualified professionals and compare multiple bids before acting.
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  // Optional fallback Payment Links (you can remove if you only want server-generated checkout)
  const PAYMENT_LINK_ONCE = "https://buy.stripe.com/test_4gM4gsaGF8cbbNdc4HeAg00";
  const PAYMENT_LINK_SUB  = "https://buy.stripe.com/test_8x26oAeWVgIH4kLecPeAg01";
  $("payOnceLink").href = PAYMENT_LINK_ONCE;
  $("subLink").href = PAYMENT_LINK_SUB;

  // Simple UX: persist a few fields
  const LS_KEY = "fairprice_v1";
  function saveForm(){
    const v = {
      category: $("category").value,
      scale: $("scale").value,
      zip: $("zip").value,
      price: $("price").value,
      quoteText: $("quoteText").value
    };
    localStorage.setItem(LS_KEY, JSON.stringify(v));
  }
  function loadForm(){
    try{
      const v = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
      if (v.category) $("category").value = v.category;
      if (v.scale) $("scale").value = v.scale;
      if (v.zip) $("zip").value = v.zip;
      if (v.price) $("price").value = v.price;
      if (v.quoteText) $("quoteText").value = v.quoteText;
    } catch {}
  }

  function setStatus(msg){ $("status").textContent = msg || ""; }

  function clamp01(x){ return Math.max(0, Math.min(1, x)); }
  function setScale(score01){
    const pct = clamp01(score01) * 100;
    $("barFill").style.width = pct + "%";
    // subtle ‚Äútrust/savings‚Äù gradient fill
    $("barFill").style.background = "linear-gradient(90deg, rgba(134,239,172,.75), rgba(110,231,255,.75))";
  }

  function showPreview(data){
    $("result").style.display = "block";
    $("fullExtras").style.display = "none";
    $("resultTitle").textContent = "Free fairness preview";
    $("resultTag").textContent = (data?.label || "RESULT").toUpperCase();
    setScale(data?.score ?? 0.5);
    $("resultText").textContent = data?.message || "Preview generated.";
  }

  function showFull(data){
    $("result").style.display = "block";
    $("fullExtras").style.display = "block";
    $("resultTitle").textContent = "Full FairPrice report";
    $("resultTag").textContent = (data?.label || "FULL").toUpperCase();
    setScale(data?.score ?? 0.5);
    $("resultText").textContent = "‚úÖ Payment verified. Full report unlocked.";

    $("marketComp").textContent = data?.full_report?.market_comparison || "‚Äî";
    $("marginEst").textContent  = data?.full_report?.estimated_margin || "‚Äî";
    $("rangeOut").textContent   = data?.full_report?.price_range || "‚Äî";
    $("tipsOut").textContent    = data?.full_report?.tips || "‚Äî";
    $("dataNote").textContent   = data?.full_report?.data_note || "";
  }

  async function toBase64(file){
    return new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result.split(",")[1]);
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }

  function getSessionIdFromUrl(){
    const p = new URLSearchParams(window.location.search);
    return p.get("session_id");
  }

  async function buildPayload(){
    const f = $("file").files[0];

    // small guardrails to prevent giant payloads from crashing your function
    if (f && f.size > 6 * 1024 * 1024) {
      throw new Error("File too large. Please upload a smaller PDF/image (~5MB).");
    }

    return {
      category: $("category").value,
      scale: $("scale").value,
      zip: $("zip").value.trim(),
      price: $("price").value.trim(),
      quoteText: $("quoteText").value.trim(),
      fileName: f ? f.name : null,
      fileType: f ? f.type : null,
      fileBase64: f ? await toBase64(f) : null
    };
  }

  async function postJSON(url, body){
    const res = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    if (!res.ok) {
      const t = await res.text();
      throw new Error(`API ${res.status}: ${t}`);
    }
    return res.json();
  }

  // Drag & drop UX
  const drop = $("drop");
  drop.addEventListener("dragover", (e) => { e.preventDefault(); drop.style.borderColor = "rgba(110,231,255,.55)"; });
  drop.addEventListener("dragleave", () => { drop.style.borderColor = "rgba(255,255,255,.18)"; });
  drop.addEventListener("drop", (e) => {
    e.preventDefault();
    drop.style.borderColor = "rgba(255,255,255,.18)";
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if (f) {
      $("file").files = e.dataTransfer.files;
      onFilePicked();
    }
  });

  function onFilePicked(){
    const f = $("file").files[0];
    $("fileLabel").textContent = f ? `${f.name} (${Math.round(f.size/1024)} KB)` : "No file selected";
    saveForm();
  }

  $("file").addEventListener("change", onFilePicked);
  ["category","scale","zip","price","quoteText"].forEach(id => $(id).addEventListener("input", saveForm));

  $("resetBtn").onclick = () => {
    localStorage.removeItem(LS_KEY);
    $("file").value = "";
    $("fileLabel").textContent = "No file selected";
    $("quoteText").value = "";
    $("zip").value = "";
    $("price").value = "";
    $("category").value = "Home services (repairs/visit)";
    $("scale").value = "medium";
    $("result").style.display = "none";
    setStatus("");
  };

  // Preview
  $("previewBtn").onclick = async () => {
    $("previewBtn").disabled = true;
    setStatus("Checking fairness‚Ä¶");
    $("result").style.display = "none";
    try{
      const payload = await buildPayload();
      const data = await postJSON("/api/analyze", { ...payload, mode:"preview" });
      setStatus("");
      showPreview(data);
    } catch(e){
      setStatus("Error: " + (e?.message || "unknown"));
    } finally {
      $("previewBtn").disabled = false;
    }
  };

  // Checkout
  async function startCheckout(kind){
    setStatus("Opening secure checkout‚Ä¶");
    try{
      const data = await postJSON("/api/create-checkout-session", { kind });
      if (data?.url) window.location.href = data.url;
      else setStatus("Checkout error (no URL).");
    } catch(e){
      setStatus("Checkout error: " + (e?.message || "unknown"));
    }
  }
  $("payOnceBtn").onclick = () => startCheckout("once");
  $("subscribeBtn").onclick = () => startCheckout("sub");

  // Auto-unlock after redirect
  (async () => {
    loadForm();
    onFilePicked();

    const sessionId = getSessionIdFromUrl();
    if (!sessionId) return;

    setStatus("Payment detected. Verifying‚Ä¶");
    try{
      const payload = await buildPayload();
      const data = await postJSON("/api/analyze", { ...payload, mode:"full", session_id: sessionId });
      setStatus("");
      showFull(data);
    } catch(e){
      setStatus("Unlock error: " + (e?.message || "unknown"));
    }
  })();
</script>
</body>
</html>
